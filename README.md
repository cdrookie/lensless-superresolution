# 自动化全息图处理脚本使用说明

## 概述
这个自动化脚本整合了全息图处理的三个主要步骤：
1. **图像预处理**：自动裁剪和配准
2. **自动对焦**：对三种颜色通道分别进行对焦
3. **重建算法**：使用获得的最佳焦点值进行图像重建

## 文件结构要求
确保您的数据文件夹具有以下结构：
```
数据文件夹名称/ (例如：20250114_1)
├── back/
│   ├── r/ (红色背景图像：1.bmp, 2.bmp, 3.bmp, 4.bmp)
│   ├── g/ (绿色背景图像：1.bmp, 2.bmp, 3.bmp, 4.bmp)
│   └── b/ (蓝色背景图像：1.bmp, 2.bmp, 3.bmp, 4.bmp)
└── hologram/
    ├── r/ (红色全息图：1.bmp, 2.bmp, 3.bmp, 4.bmp)
    ├── g/ (绿色全息图：1.bmp, 2.bmp, 3.bmp, 4.bmp)
    └── b/ (蓝色全息图：1.bmp, 2.bmp, 3.bmp, 4.bmp)
```

## 使用方法

### 快速开始
1. 将您的数据文件夹放在脚本同级目录下
2. 运行 `run_automated_processing.m`
3. 修改脚本中的 `data_folder` 变量为您的文件夹名称

### 详细使用
```matlab
% 在MATLAB中运行
clear; clc; close all;

% 设置参数
data_folder = '20250114_1';  % 您的数据文件夹名称
crop_size = 600;             % 裁剪大小

% 运行自动化处理
automated_hologram_processing(data_folder, crop_size);
```

## 主要功能

### 1. 自动裁剪
- 自动扫描全图像，找到信号最强的区域
- 使用方差、梯度和频域能量的综合评分
- 可自定义裁剪大小

### 2. 自动对焦
- 对三种颜色（红、绿、蓝）分别进行自动对焦
- 使用NOG（Normalized Gradient）清晰度函数
- 自动搜索1200-1700μm的距离范围
- 生成对焦曲线图

### 3. 图像重建
- 使用WFi（Wirtinger Flow incremental）算法
- 自动应用最佳焦点距离
- 生成振幅和相位重建结果

## 输出结果

### 生成的文件
1. `Filter_Holo_[时间戳].mat` - 预处理后的数据
2. `cell_num_1.mat` - 重建的相位信息
3. 多个图形窗口显示：
   - 对焦曲线（每种颜色一个）
   - 重建的振幅和相位图像
   - 算法收敛曲线

### 控制台输出
- 处理进度信息
- 最佳裁剪位置坐标
- 三种颜色的最佳焦点距离
- 子像素配准结果

## 参数调整

### 可调整的参数
- `crop_size`: 裁剪区域大小（默认600像素）
- `dist_range`: 对焦搜索范围（默认1200:5:1700μm）
- `step_size`: 裁剪位置搜索步长（默认50像素）

### 波长设置
- 红色：0.625μm
- 绿色：0.525μm  
- 蓝色：0.470μm

## 故障排除

### 常见问题
1. **文件路径错误**：确保数据文件夹结构正确
2. **内存不足**：减小裁剪大小或图像尺寸
3. **对焦失败**：检查距离搜索范围是否合适

### 错误信息
- 如果出现"文件不存在"错误，检查文件路径和文件名
- 如果出现"维度不匹配"错误，检查图像尺寸是否一致

## 修改说明

### 相比原始代码的主要修改
1. **图像数量**：从48张（每色16张）改为12张（每色4张）
2. **自动裁剪**：添加了自动寻找最佳裁剪区域的功能
3. **自动对焦**：集成了三种颜色的自动对焦功能
4. **一键处理**：整合了整个工作流程

### 通道对应关系
- 原始：auto_channel = 1(红), 17(绿), 33(蓝) （对应第1、17、33张图，共48张）
- 修改后：auto_channel = 1(红), 5(绿), 9(蓝) （对应第1、5、9张图，共12张）

### 图像索引分布
- 红色通道：第1-4张图片
- 绿色通道：第5-8张图片  
- 蓝色通道：第9-12张图片

## 技术细节

### 算法参数
- 正则化参数λ = 1e-3
- 步长γ = 2  
- 主循环迭代次数 = 5
- TV去噪迭代次数 = 5

### 硬件要求
- MATLAB R2018b或更高版本
- 建议内存：8GB以上
- 处理时间：约5-15分钟（取决于图像大小）
